import { walkDir } from "@owlprotocol/utils";
import { existsSync, mkdirSync, readFileSync } from "fs";
import { basename, join } from "path";

export async function generateBeaconFactoryExports(
    inputPath = "src/typechain/ethers/factories",
    outputPath = "src/factories",
    beaconFactoryUtilsPath = "@owlprotocol/contracts-proxy",
    omitContracts: string[] = [],
) {
    if (!existsSync(outputPath)) {
        mkdirSync(outputPath);
    }
    const outputFiles: Record<string, string> = {};
    for await (const file of walkDir(inputPath)) {
        const fileContents = readFileSync(file, "utf-8");
        if (!file.endsWith("__factory.ts")) {
            //console.debug(`Skipping non *__factory.ts file: ${file}`);
            continue;
        }

        const contractName = basename(file).replace("__factory.ts", "");
        if (omitContracts.includes(contractName)) {
            console.debug(`Skipping contract ${contractName} as omitted explictly.`);
            continue;
        } else if (!fileContents.includes("extends ContractFactory")) {
            //console.debug(`Skipping non-deployable contract ${contractName}`);
            continue;
        } else if (!fileContents.includes(`name: "initialize"`)) {
            console.debug(
                `Skipping non-initializable contract ${contractName}. Make initializable to enable beacon deployment.`,
            );
            continue;
        }

        const zodExists = existsSync(`src/zsol/${contractName}.ts`);
        if (!zodExists) {
            console.debug(
                `Skipping non-zod validated contract ${contractName}. Create zod validator for contract to enable beacon deployment.`,
            );
            continue;
        }

        const contractFactoryPath = file.replace("src/", "../").replace(".ts", ".js");
        const fileOutput = generateBeaconFactoryExportFile(contractName, contractFactoryPath, beaconFactoryUtilsPath);
        outputFiles[join(outputPath, `${contractName}.ts`)] = fileOutput;
    }

    return outputFiles;
}

export function generateBeaconFactoryExportFile(
    contractName: string,
    contractFactoryPath: string,
    beaconFactoryUtilsPath: string,
) {
    const fileContents = `/* Autogenerated file. Do not edit manually. */
import { getDeployFactories, getFactoryWithInitializeUtil } from "${beaconFactoryUtilsPath}";
import { ${contractName}__factory as Contract__factory } from "${contractFactoryPath}";
import { ${contractName} as ContractZod } from "../zsol/${contractName}.js";

const initializeZod = ContractZod.initialize.inputsDefinedArrayify;
const initializeFunction = (args: (typeof initializeZod)["_input"]) => initializeZod.parse(args);

const Contract__factory__beacon = getFactoryWithInitializeUtil<
    Contract__factory,
    (typeof initializeZod)["_input"],
    typeof initializeFunction
>(getDeployFactories(new Contract__factory()), initializeFunction);

export const ${contractName}__factory__beacon = Contract__factory__beacon as any;
`;
    return fileContents;
}
